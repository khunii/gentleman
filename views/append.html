<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link href="/css/signin.css" rel="stylesheet">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
        });
    </script>
    <title>Gentleman</title>
</head>

<body class="text-center">
    <div class="form-signin" id="postman">
        <img src="/img/postman.png" height="190" , width="211">
        <br />
        <br />
        <br />
        <br/>
        <div class="alert alert-success" role="alert">
            <h4 class="alert-heading">기존 Collection에 선택한 API를 추가합니다.</h4>
            <p>Collection을 import 후 추가할 API를 선택하세요.</p>
            <div class="input-group">
                <div class="custom-file">
                    <input type="file" id="collection" class="custom-file-input" aria-describedby="button-addon4" required>
                    <label class="custom-file-label text-left" for="collection">테스트중인 Postman Collection을 선택하세요</label>
                </div>
                <div class="input-group-append" id="button-addon4">
                    <button class="btn btn-secondary" type="button">Import</button>
                </div>
            </div>
            <hr>
            <p class="mb-0">추가할 API가 있는 Swagger-ui 상단에 있는 api-docs url을 필요로 합니다.</p>
            <div class="input-group mb3">
                <input type="text" id="surl" class="form-control" aria-describedby="button-addon2" placeholder="Swagger api-docs URL"" required>
                <div class="input-group-append" id="button-addon2">
                    <button class="btn btn-success" type="button">API 리스트요청</button>
                </div>
            </div>
        </div>
        <br/>
        <button type=" button" class="btn btn-lg btn-primary btn-block" id="gen">Collecton에 API추가</button>
        <div id="result"></div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalCenterTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="mdmsg"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('#gen_old').click(function () {
            var gentleman = { author: $('#author').val(), surl: $('#surl').val() };
            $.ajax({
                url: "http://localhost:9900/gentleman",
                type: "POST",
                data: gentleman,
                dataType: "json",
                success: function (result) {
                    var blob = new Blob([JSON.stringify(result.collection)]);
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = result.collection.name + ".json";
                    link.click();
                    var blob2 = new Blob([JSON.stringify(result.env)]);
                    var link2 = document.createElement('a');
                    link2.href = window.URL.createObjectURL(blob2);
                    link2.download = result.env.name + ".json";
                    link2.click();

                    $('#exampleModalCenter').on('show.bs.modal', function () {
                        $('#exampleModalCenterTitle').text('작업 완료');
                        $('#mdmsg').html('Collection이 생성되어 다운로드 되었습니다.');
                    })
                    $('#exampleModalCenter').modal('toggle');

                },
                error: function (req, status, err) {
                    $('#exampleModalCenter').on('show.bs.modal', function () {
                        $('#exampleModalCenterTitle').text('작업 오류(' + req.status + ')');
                        $('#mdmsg').html(req.responseText);
                    })
                    $('#exampleModalCenter').modal('toggle');
                }

            })
        })
        $('#gen').click(function () {
            //var gentleman = { author: $('#author').val(), surl: $('#surl').val() };
            var surl = $('#surl').val();
            $.ajax({
                url: surl,
                type: "GET",
                // beforeSend: function (xhr) {
                //     xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
                //     xhr.setRequestHeader("Access-Control-Allow-Headers", "origin, x-requested-with, content-type, accept");
                // },
                success: function (result) {
                    var swaggerJson = JSON.stringify(result);
                    console.log(swaggerJson);
                    var gentleman = { author: $('#author').val(), swgrJson: swaggerJson };
                    $.ajax({
                        url: "http://localhost:9900/gentleman/fromjson",
                        type: "POST",
                        data: gentleman,
                        //contentType:"application/json; charset=utf-8",
                        dataType: "json",
                        success: function (result) {
                            var blob = new Blob([JSON.stringify(result.collection)]);
                            var link = document.createElement('a');
                            link.href = window.URL.createObjectURL(blob);
                            link.download = result.collection.name + ".json";
                            link.click();
                            var blob2 = new Blob([JSON.stringify(result.env)]);
                            var link2 = document.createElement('a');
                            link2.href = window.URL.createObjectURL(blob2);
                            link2.download = result.env.name + ".json";
                            link2.click();

                            $('#exampleModalCenter').on('show.bs.modal', function () {
                                $('#exampleModalCenterTitle').text('작업 완료');
                                $('#mdmsg').html('Collection이 생성되어 다운로드 되었습니다.');
                            })
                            $('#exampleModalCenter').modal('toggle');

                        },
                        error: function (req, status, err) {
                            $('#exampleModalCenter').on('show.bs.modal', function () {
                                $('#exampleModalCenterTitle').text('작업 오류(' + req.status + ')');
                                $('#mdmsg').html(req.responseText);
                            })
                            $('#exampleModalCenter').modal('toggle');
                        }
                    })
                },
                error: function (req, status, err) {
                    $('#exampleModalCenter').on('show.bs.modal', function () {
                        $('#exampleModalCenterTitle').text('작업 오류(400)');
                        $('#mdmsg').html('Swagger URL 을 정확히 입력해 주세요');
                    })
                    $('#exampleModalCenter').modal('toggle');
                }

            })
        })
    </script>
</body>

</html>